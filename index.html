<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Minimalist XRPL Client</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .input-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #555;
      }
      input {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        box-sizing: border-box;
      }
      input:focus {
        border-color: #007bff;
        outline: none;
      }
      button {
        background-color: #007bff;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-right: 10px;
        margin-bottom: 10px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .results {
        margin-top: 30px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #e9ecef;
      }
      .results h3 {
        color: #333;
        margin-top: 0;
      }
      .account-info {
        display: grid;
        gap: 10px;
      }
      .info-item {
        display: flex;
        justify-content: space-between;
        padding: 8px;
        background-color: white;
        border-radius: 3px;
        border: 1px solid #dee2e6;
      }
      .info-label {
        font-weight: bold;
        color: #495057;
      }
      .info-value {
        color: #6c757d;
        word-break: break-all;
      }
      .error {
        color: #dc3545;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 12px;
        border-radius: 5px;
        margin-top: 15px;
      }
      .success {
        color: #155724;
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        padding: 12px;
        border-radius: 5px;
        margin-top: 15px;
      }
      .loading {
        text-align: center;
        color: #6c757d;
        font-style: italic;
      }
      .network-status {
        text-align: center;
        margin-bottom: 20px;
        padding: 10px;
        border-radius: 5px;
      }
      .connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Minimalist XRPL Client</h1>

      <div id="networkStatus" class="network-status disconnected">
        Disconnected from XRPL Network
      </div>

      <div class="input-group">
        <label for="secretKey">Secret Key (seed):</label>
        <input
          type="password"
          id="secretKey"
          placeholder="Enter your XRPL secret key (e.g., sXXXXXXXXXXXXXXXXXXXXXXXXXXXX)"
        />
      </div>

      <div class="input-group">
        <label for="destinationAddress">Destination Address:</label>
        <input
          type="text"
          id="destinationAddress"
          placeholder="Enter destination XRPL address (e.g., rXXXXXXXXXXXXXXXXXXXXXXXXXXXX)"
        />
      </div>

      <div class="input-group">
        <label for="amount">Amount (XRP):</label>
        <input
          type="number"
          id="amount"
          placeholder="Enter amount to send"
          step="0.000001"
          min="0.000001"
        />
      </div>

      <div class="input-group">
        <label for="destinationTag">Destination Tag (optional):</label>
        <input
          type="number"
          id="destinationTag"
          placeholder="Enter destination tag (if required)"
          min="0"
        />
      </div>

      <button onclick="deriveAddress()">Derive Address</button>
      <button onclick="getAccountInfo()">Get Account Info</button>
      <button onclick="sendPayment()">Send XRP</button>
      <button onclick="connectToNetwork()">Connect to Network</button>
      <button onclick="clearResults()">Clear Results</button>

      <div id="results" class="results" style="display: none">
        <h3>Results</h3>
        <div id="resultContent"></div>
      </div>
    </div>
    <script src="https://unpkg.com/xrpl@3.1.0/build/xrpl-latest-min.js"></script>

    <script>
      let client = null;
      let currentWallet = null;

      // Initialize XRPL client
      async function connectToNetwork() {
        try {
          updateStatus("Connecting to XRPL Network...", "loading");

          // Connect to XRPL Testnet (you can change this to Mainnet)
          client = new xrpl.Client("wss://s1.ripple.com/");
          await client.connect();

          updateStatus("Connected to XRPL Testnet", "connected");
          showMessage("Successfully connected to XRPL network!", "success");
        } catch (error) {
          updateStatus("Failed to connect to XRPL Network", "disconnected");
          showMessage("Error connecting to network: " + error.message, "error");
        }
      }

      // Derive address from secret key
      function deriveAddress() {
        const secretKey = document.getElementById("secretKey").value.trim();

        if (!secretKey) {
          showMessage("Please enter a secret key", "error");
          return;
        }

        try {
          // Create wallet from secret
          currentWallet = xrpl.Wallet.fromSeed(secretKey);

          const resultHtml = `
                    <div class="account-info">
                        <div class="info-item">
                            <span class="info-label">Address:</span>
                            <span class="info-value">${currentWallet.address}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Public Key:</span>
                            <span class="info-value">${currentWallet.publicKey}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Private Key:</span>
                            <span class="info-value">${currentWallet.privateKey}</span>
                        </div>
                    </div>
                `;

          showResults(resultHtml);
          showMessage("Address derived successfully!", "success");
        } catch (error) {
          showMessage("Error deriving address: " + error.message, "error");
        }
      }

      // Get account information from the ledger
      async function getAccountInfo() {
        if (!client) {
          showMessage("Please connect to the network first", "error");
          return;
        }

        if (!currentWallet) {
          showMessage("Please derive an address first", "error");
          return;
        }

        try {
          showMessage("Fetching account information...", "loading");
          console.log("Fetching account info for:", currentWallet.address);

          // Get account info
          const accountInfo = await client.request({
            command: "account_info",
            account: currentWallet.address,
            ledger_index: "validated",
          });

          console.log("Account Info:", accountInfo);

          // Get account lines (trust lines)
          let accountLines = null;
          try {
            const linesResponse = await client.request({
              command: "account_lines",
              account: currentWallet.address,
              ledger_index: "validated",
            });
            accountLines = linesResponse.result.lines;
          } catch (e) {
            // Account might not have trust lines
            accountLines = [];
          }

          const account = accountInfo.result.account_data;
          const balance = xrpl.dropsToXrp(account.Balance);

          let resultHtml = `
                    <div class="account-info">
                        <div class="info-item">
                            <span class="info-label">Address:</span>
                            <span class="info-value">${
                              currentWallet.address
                            }</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">XRP Balance:</span>
                            <span class="info-value">${balance} XRP</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Sequence:</span>
                            <span class="info-value">${account.Sequence}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Owner Count:</span>
                            <span class="info-value">${
                              account.OwnerCount
                            }</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Reserve:</span>
                            <span class="info-value">${xrpl.dropsToXrp(
                              account.Reserve || "0"
                            )} XRP</span>
                        </div>
                `;

          if (account.EmailHash) {
            resultHtml += `
                        <div class="info-item">
                            <span class="info-label">Email Hash:</span>
                            <span class="info-value">${account.EmailHash}</span>
                        </div>
                    `;
          }

          if (accountLines && accountLines.length > 0) {
            resultHtml += `
                        <div class="info-item">
                            <span class="info-label">Trust Lines:</span>
                            <span class="info-value">${accountLines.length} lines</span>
                        </div>
                    `;

            accountLines.forEach((line, index) => {
              resultHtml += `
                            <div class="info-item">
                                <span class="info-label">Token ${
                                  index + 1
                                }:</span>
                                <span class="info-value">${line.balance} ${
                line.currency
              }</span>
                            </div>
                        `;
            });
          }

          resultHtml += "</div>";

          showResults(resultHtml);
          showMessage("Account information retrieved successfully!", "success");
        } catch (error) {
          console.log(error);
          if (error.data && error.data.error === "actNotFound") {
            showMessage(
              "Account not found. This address has not been activated on the XRPL network.",
              "error"
            );
          } else {
            showMessage(
              "Error fetching account info: " + error.message,
              "error"
            );
          }
        }
      }

      // Send XRP payment
      async function sendPayment() {
        if (!client) {
          showMessage("Please connect to the network first", "error");
          return;
        }

        if (!currentWallet) {
          showMessage("Please derive an address first", "error");
          return;
        }

        const destinationAddress = document.getElementById("destinationAddress").value.trim();
        const amount = document.getElementById("amount").value.trim();
        const destinationTag = document.getElementById("destinationTag").value.trim();

        // Validation
        if (!destinationAddress) {
          showMessage("Please enter a destination address", "error");
          return;
        }

        if (!amount || parseFloat(amount) <= 0) {
          showMessage("Please enter a valid amount greater than 0", "error");
          return;
        }

        // Validate destination address format
        if (!destinationAddress.startsWith('r') || destinationAddress.length < 25) {
          showMessage("Invalid destination address format", "error");
          return;
        }

        try {
          showMessage("Preparing payment transaction...", "loading");

          // Prepare payment transaction
          const payment = {
            TransactionType: "Payment",
            Account: currentWallet.address,
            Amount: xrpl.xrpToDrops(amount),
            Destination: destinationAddress
          };

          // Add destination tag if provided
          if (destinationTag && parseInt(destinationTag) >= 0) {
            payment.DestinationTag = parseInt(destinationTag);
          }

          console.log("Payment object:", payment);

          // Auto-fill transaction details
          const prepared = await client.autofill(payment);
          console.log("Prepared payment:", prepared);

          // Sign the transaction
          const signed = currentWallet.sign(prepared);
          console.log("Signed payment:", signed);

          showMessage("Submitting payment to XRPL network...", "loading");

          // Submit the transaction
          const result = await client.submitAndWait(signed.tx_blob);
          console.log("Transaction result:", result);

          if (result.result.meta.TransactionResult === "tesSUCCESS") {
            const resultHtml = `
              <div class="account-info">
                <div class="info-item">
                  <span class="info-label">Transaction Hash:</span>
                  <span class="info-value">${result.result.hash}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">From:</span>
                  <span class="info-value">${currentWallet.address}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">To:</span>
                  <span class="info-value">${destinationAddress}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Amount:</span>
                  <span class="info-value">${amount} XRP</span>
                </div>
                ${destinationTag ? `
                <div class="info-item">
                  <span class="info-label">Destination Tag:</span>
                  <span class="info-value">${destinationTag}</span>
                </div>
                ` : ''}
                <div class="info-item">
                  <span class="info-label">Fee:</span>
                  <span class="info-value">${xrpl.dropsToXrp(prepared.Fee)} XRP</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Status:</span>
                  <span class="info-value">Success</span>
                </div>
              </div>
            `;
            
            showResults(resultHtml);
            showMessage("Payment sent successfully!", "success");
            
            // Clear payment form
            document.getElementById("destinationAddress").value = "";
            document.getElementById("amount").value = "";
            document.getElementById("destinationTag").value = "";
            
          } else {
            showMessage(`Payment failed: ${result.result.meta.TransactionResult}`, "error");
          }

        } catch (error) {
          console.error("Payment error:", error);
          if (error.data && error.data.error_message) {
            showMessage(`Payment failed: ${error.data.error_message}`, "error");
          } else {
            showMessage(`Payment failed: ${error.message}`, "error");
          }
        }
      }

      // Utility functions
      function showResults(html) {
        document.getElementById("resultContent").innerHTML = html;
        document.getElementById("results").style.display = "block";
      }

      function showMessage(message, type) {
        const existingMessage = document.querySelector(
          ".error, .success, .loading"
        );
        if (existingMessage) {
          existingMessage.remove();
        }

        const messageDiv = document.createElement("div");
        messageDiv.className = type;
        messageDiv.textContent = message;

        const container = document.querySelector(".container");
        container.appendChild(messageDiv);

        if (type !== "loading") {
          setTimeout(() => {
            if (messageDiv.parentNode) {
              messageDiv.remove();
            }
          }, 5000);
        }
      }

      function updateStatus(message, status) {
        const statusElement = document.getElementById("networkStatus");
        statusElement.textContent = message;
        statusElement.className = `network-status ${status}`;
      }

      function clearResults() {
        document.getElementById("results").style.display = "none";
        document.getElementById("resultContent").innerHTML = "";

        const messages = document.querySelectorAll(
          ".error, .success, .loading"
        );
        messages.forEach((msg) => msg.remove());
      }

      // Auto-connect on page load
      window.addEventListener("load", () => {
        // You can uncomment this to auto-connect
        // connectToNetwork();
      });
    </script>
  </body>
</html>
