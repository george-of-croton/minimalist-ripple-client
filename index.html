<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Tristero XRP Wallet - A secure, browser-based XRP wallet for XRPL blockchain. Send payments, view transactions, explore accounts, and manage your XRP holdings with real-time ledger data."
    />
    <meta
      name="keywords"
      content="Tristero, XRP Wallet, XRPL, Ripple, Blockchain, Cryptocurrency, XRP Payments, Ledger Explorer, Crypto Wallet, Browser Wallet, Decentralized Finance, DeFi"
    />
    <meta
      name="google-site-verification"
      content="mT_TlAXFw6Ce1iZ5FmiZwrbY-mJT6FvVpauIcWXxxJk"
    />
    <meta name="author" content="Tristero XRP Wallet" />
    <meta property="og:title" content="Tristero XRP Wallet" />
    <meta
      property="og:description"
      content="Secure browser-based XRP wallet for XRPL blockchain transactions, account management, and real-time ledger exploration."
    />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://george-of-croton.github.io/minimalist-ripple-client/"
    />
    <meta
      property="og:image"
      content="https://george-of-croton.github.io/minimalist-ripple-client/og-image.png"
    />
    <meta property="og:site_name" content="Tristero XRP Wallet" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content="Tristero XRP Wallet - XRPL Browser Wallet"
    />
    <meta
      name="twitter:description"
      content="Secure browser-based XRP wallet for XRPL blockchain transactions and account management."
    />
    <meta
      name="twitter:image"
      content="https://george-of-croton.github.io/minimalist-ripple-client/og-image.png"
    />
    <meta name="theme-color" content="#ff6b00" />
    <link
      rel="canonical"
      href="https://george-of-croton.github.io/minimalist-ripple-client/"
    />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="icon" type="image/svg+xml" sizes="16x16" href="favicon-16.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="favicon.svg" />
    <link rel="manifest" href="site.webmanifest" />
    <!-- <meta
      http-equiv="Content-Security-Policy"
      content="script-src 'self' http://34.201.238.250:3000/track.js  https://unpkg.com 'unsafe-inline'; connect-src 'self' http://34.201.238.250:3000/track.js wss://s1.ripple.com;"
    /> -->
    <title>Tristero XRP Wallet</title>
    <style>
      :root {
        --primary: #ff6b00;
        --primary-dark: #e55a00;
        --bg: #0a0a0a;
        --card-bg: #1a1a1a;
        --text: #ffffff;
        --text-secondary: #a0a0a0;
        --border: #2a2a2a;
        --success: #10b981;
        --error: #ef4444;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .container {
        max-width: 480px;
        width: 100%;
      }
      .header {
        text-align: center;
        margin-bottom: 40px;
      }
      .logo {
        font-size: 2rem;
        margin-bottom: 8px;
      }
      h1 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 4px;
      }
      .subtitle {
        color: var(--text-secondary);
        font-size: 0.875rem;
      }
      .card {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 16px;
      }
      .card-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 16px;
      }
      .balance {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 8px;
      }
      .balance-label {
        color: var(--text-secondary);
        font-size: 0.875rem;
      }
      .input-group {
        margin-bottom: 16px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 500;
      }
      input {
        width: 100%;
        padding: 14px;
        border: 1px solid var(--border);
        border-radius: 12px;
        font-size: 1rem;
        background: var(--bg);
        color: var(--text);
        transition: all 0.2s;
      }
      input:focus {
        outline: none;
        border-color: var(--primary);
      }
      input::placeholder {
        color: var(--text-secondary);
      }
      button {
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 12px;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-1px);
      }
      .btn-secondary {
        background: var(--card-bg);
        color: var(--text);
        border: 1px solid var(--border);
      }
      .btn-secondary:hover {
        background: var(--border);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }
      .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--border);
      }
      .info-row:last-child {
        border-bottom: none;
      }
      .info-label {
        color: var(--text-secondary);
        font-size: 0.875rem;
      }
      .info-value {
        color: var(--text);
        font-weight: 500;
        font-family: monospace;
        font-size: 0.875rem;
      }
      .status {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 600;
      }
      .message {
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 16px;
        font-size: 0.875rem;
      }
      .error {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid var(--error);
        color: var(--error);
      }
      .success {
        background: rgba(16, 185, 129, 0.1);
        border: 1px solid var(--success);
        color: var(--success);
      }
      .loading {
        background: rgba(160, 160, 160, 0.1);
        border: 1px solid var(--border);
        color: var(--text-secondary);
      }
      .network-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 24px;
      }
      .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--error);
      }
      .dot.connected {
        background: var(--success);
      }
      .copy-btn {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 0.75rem;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
        margin-left: 8px;
      }
      .copy-btn:hover {
        background: var(--border);
        color: var(--text);
      }
      .tx-detail {
        margin-top: 8px;
        padding: 8px;
        background: rgba(255, 107, 0, 0.05);
        border-radius: 8px;
        font-size: 0.75rem;
      }
      .tx-detail-row {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        border-bottom: 1px solid rgba(255, 107, 0, 0.1);
      }
      .tx-detail-row:last-child {
        border-bottom: none;
      }
      .clickable-tx {
        cursor: pointer;
        transition: background 0.2s;
      }
      .clickable-tx:hover {
        background: rgba(255, 107, 0, 0.05);
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
      }
      .modal-content {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
      }
      .modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 8px;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        color: var(--text);
        font-size: 1.25rem;
        transition: all 0.2s;
      }
      .modal-close:hover {
        background: var(--border);
      }
      .address-display {
        font-family: monospace;
        font-size: 0.875rem;
        word-break: break-all;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="logo">ðŸ“¯</div>
        <h1>Tristero</h1>
        <p class="subtitle">XRP Wallet</p>
      </div>

      <div class="network-indicator">
        <span class="dot" id="networkDot"></span>
        <span id="networkText">Connecting...</span>
      </div>

      <div id="messageContainer"></div>

      <!-- Wallet Connection -->
      <div class="card" id="connectCard">
        <div class="card-title">Connect or Lookup Wallet</div>
        <div class="input-group">
          <label for="secretKey">Secret Key or Address</label>
          <input
            type="text"
            id="secretKey"
            placeholder="Secret key (sXXX...) or Address (rXXX...)"
          />
        </div>
        <button class="btn-primary" onclick="connectWallet()">
          Connect / Lookup
        </button>
      </div>

      <!-- Account Info -->
      <div class="card" id="accountCard" style="display: none">
        <div class="card-title">Account</div>
        <div class="balance" id="balance">0 XRP</div>
        <div class="balance-label">Available Balance</div>
        <div style="margin-top: 20px">
          <div class="info-row" style="flex-direction: column; align-items: flex-start;">
            <span class="info-label">Address</span>
            <div class="address-display">
              <span class="info-value" id="address">-</span>
              <button class="copy-btn" onclick="copyAddress()" title="Copy address">
                ðŸ“‹ Copy
              </button>
            </div>
          </div>
          <div class="info-row">
            <span class="info-label">Reserve</span>
            <span class="info-value" id="reserve">-</span>
          </div>
        </div>
        <button
          class="btn-secondary"
          onclick="disconnectWallet()"
          style="margin-top: 16px"
        >
          Disconnect
        </button>
      </div>

      <!-- Transactions -->
      <div class="card" id="transactionsCard" style="display: none">
        <div class="card-title">Recent Transactions</div>
        <div
          id="transactionsList"
          style="max-height: 400px; overflow-y: auto"
        ></div>
      </div>

      <!-- Send Payment -->
      <div class="card" id="sendCard" style="display: none">
        <div class="card-title">Send XRP</div>
        <div class="input-group">
          <label for="destinationAddress">To Address</label>
          <input
            type="text"
            id="destinationAddress"
            placeholder="rXXXXXXXXXXXXXXXXXXXXXXXXXXXXX or rXXX:12345"
            list="addressHistory"
            oninput="handleAddressInput()"
          />
          <datalist id="addressHistory"></datalist>
        </div>
        <div class="input-group">
          <label for="amount">Amount (XRP)</label>
          <input
            type="number"
            id="amount"
            placeholder="0.00"
            step="0.000001"
            min="0.000001"
          />
        </div>
        <div class="input-group">
          <label for="destinationTag">Destination Tag (optional)</label>
          <input
            type="number"
            id="destinationTag"
            placeholder="Leave empty if not required"
            min="0"
          />
        </div>
        <button class="btn-primary" onclick="sendPayment()">
          Send Payment
        </button>
      </div>
    </div>

    <!-- Transaction Detail Modal -->
    <div id="txModal" class="modal-overlay" style="display: none;" onclick="closeTransactionModal(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-close" onclick="closeTransactionModal()">Ã—</div>
        <div class="card-title">Transaction Details</div>
        <div id="txModalContent" style="margin-top: 16px;"></div>
      </div>
    </div>

    <script src="https://unpkg.com/xrpl@3.1.0/build/xrpl-latest-min.js"></script>
    <script>
      let client = null;
      let currentWallet = null;
      const ADDRESS_HISTORY_KEY = "xrp_address_history";
      const MAX_HISTORY = 10;
      let currentAddress = null;

      // Copy address to clipboard
      function copyAddress() {
        const addressText = currentAddress;
        if (!addressText) return;
        
        navigator.clipboard.writeText(addressText).then(() => {
          showMessage("Address copied to clipboard!", "success");
        }).catch(() => {
          showMessage("Failed to copy address", "error");
        });
      }

      // View transaction details in modal
      async function viewTransactionDetails(txHash) {
        try {
          showMessage("Loading transaction details...", "loading");
          
          const txResult = await client.request({
            command: "tx",
            transaction: txHash,
            binary: false
          });

          const tx = txResult.result;
          const rippleEpochOffset = 946684800;
          const date = tx.date ? new Date((tx.date + rippleEpochOffset) * 1000) : new Date();

          let html = `
            <div class="tx-detail">
              <div class="tx-detail-row">
                <span class="info-label">Hash</span>
                <span class="info-value" style="word-break: break-all;">${tx.hash}</span>
              </div>
              <div class="tx-detail-row">
                <span class="info-label">Type</span>
                <span class="info-value">${tx.TransactionType}</span>
              </div>
              <div class="tx-detail-row">
                <span class="info-label">Date</span>
                <span class="info-value">${date.toLocaleString()}</span>
              </div>
              <div class="tx-detail-row">
                <span class="info-label">Ledger Index</span>
                <span class="info-value">${tx.ledger_index}</span>
              </div>
              <div class="tx-detail-row">
                <span class="info-label">Status</span>
                <span class="info-value" style="color: ${tx.meta?.TransactionResult === 'tesSUCCESS' ? 'var(--success)' : 'var(--error)'}">
                  ${tx.meta?.TransactionResult || 'Unknown'}
                </span>
              </div>
              <div class="tx-detail-row">
                <span class="info-label">From Account</span>
                <span class="info-value" style="word-break: break-all;">${tx.Account}</span>
              </div>
              ${tx.Destination ? `
                <div class="tx-detail-row">
                  <span class="info-label">To Account</span>
                  <span class="info-value" style="word-break: break-all;">${tx.Destination}</span>
                </div>
              ` : ''}
              ${tx.Amount ? `
                <div class="tx-detail-row">
                  <span class="info-label">Amount</span>
                  <span class="info-value">${typeof tx.Amount === 'string' ? xrpl.dropsToXrp(tx.Amount) + ' XRP' : JSON.stringify(tx.Amount)}</span>
                </div>
              ` : ''}
              ${tx.Fee ? `
                <div class="tx-detail-row">
                  <span class="info-label">Fee</span>
                  <span class="info-value">${xrpl.dropsToXrp(tx.Fee)} XRP</span>
                </div>
              ` : ''}
              ${tx.Sequence ? `
                <div class="tx-detail-row">
                  <span class="info-label">Sequence</span>
                  <span class="info-value">${tx.Sequence}</span>
                </div>
              ` : ''}
              ${tx.DestinationTag !== undefined ? `
                <div class="tx-detail-row">
                  <span class="info-label">Destination Tag</span>
                  <span class="info-value">${tx.DestinationTag}</span>
                </div>
              ` : ''}
              ${tx.SourceTag !== undefined ? `
                <div class="tx-detail-row">
                  <span class="info-label">Source Tag</span>
                  <span class="info-value">${tx.SourceTag}</span>
                </div>
              ` : ''}
              ${tx.Memos && tx.Memos.length > 0 ? `
                <div class="tx-detail-row">
                  <span class="info-label">Memos</span>
                  <span class="info-value">${JSON.stringify(tx.Memos, null, 2)}</span>
                </div>
              ` : ''}
            </div>
          `;

          document.getElementById("txModalContent").innerHTML = html;
          document.getElementById("txModal").style.display = "flex";
          clearMessage();
        } catch (error) {
          console.error("Error loading transaction details:", error);
          showMessage("Failed to load transaction details", "error");
        }
      }

      function closeTransactionModal(event) {
        if (!event || event.target.id === 'txModal' || event.target.className === 'modal-close') {
          document.getElementById("txModal").style.display = "none";
        }
      }

      function clearMessage() {
        const existing = document.querySelector(".message");
        if (existing) existing.remove();
      }

      // Address history functions
      function loadAddressHistory() {
        try {
          const history = localStorage.getItem(ADDRESS_HISTORY_KEY);
          return history ? JSON.parse(history) : [];
        } catch (e) {
          return [];
        }
      }

      function saveAddressToHistory(address) {
        try {
          let history = loadAddressHistory();
          // Remove if already exists
          history = history.filter((addr) => addr !== address);
          // Add to beginning
          history.unshift(address);
          // Keep only MAX_HISTORY entries
          history = history.slice(0, MAX_HISTORY);
          localStorage.setItem(ADDRESS_HISTORY_KEY, JSON.stringify(history));
          updateAddressDatalist();
        } catch (e) {
          console.error("Failed to save address:", e);
        }
      }

      function updateAddressDatalist() {
        const datalist = document.getElementById("addressHistory");
        const history = loadAddressHistory();
        datalist.innerHTML = history
          .map((addr) => `<option value="${addr}">`)
          .join("");
      }

      // Handle address input with automatic tag detection
      function handleAddressInput() {
        const input = document
          .getElementById("destinationAddress")
          .value.trim();

        // Check for address:tag format
        if (input.includes(":")) {
          const parts = input.split(":");
          const address = parts[0].trim();
          const tag = parts[1].trim();

          // Update fields
          document.getElementById("destinationAddress").value = address;
          document.getElementById("destinationTag").value = tag;
        }
      }

      // Connect to XRPL network
      async function connectToNetwork() {
        try {
          updateNetworkStatus("Connecting...", false);
          client = new xrpl.Client("wss://s1.ripple.com");
          await client.connect();
          updateNetworkStatus("Connected to XRPL", true);
        } catch (error) {
          updateNetworkStatus("Connection failed", false);
          showMessage("Failed to connect to XRPL network", "error");
        }
      }

      // Connect wallet
      async function connectWallet() {
        const input = document.getElementById("secretKey").value.trim();

        if (!input) {
          showMessage("Please enter a secret key or address", "error");
          return;
        }

        try {
          // Check if it's an address (starts with 'r') or secret key (starts with 's')
          if (input.startsWith("r")) {
            // Lookup mode - view only
            await lookupAddress(input);
          } else {
            // Connect mode - full wallet access
            currentWallet = xrpl.Wallet.fromSeed(input);
            await refreshBalance();
            await loadTransactions(currentWallet.address);

            document.getElementById("connectCard").style.display = "none";
            document.getElementById("accountCard").style.display = "block";
            document.getElementById("transactionsCard").style.display = "block";
            document.getElementById("sendCard").style.display = "block";

            showMessage("Wallet connected successfully!", "success");
          }
        } catch (error) {
          if (error.data?.error === "actNotFound") {
            showMessage(
              "Account not found. Make sure it has been activated with XRP.",
              "error"
            );
          } else {
            showMessage("Failed to connect wallet: " + error.message, "error");
          }
        }
      }

      // Lookup address (view-only mode)
      async function lookupAddress(address) {
        const accountInfo = await client.request({
          command: "account_info",
          account: address,
          ledger_index: "validated",
        });

        const balance = xrpl.dropsToXrp(
          accountInfo.result.account_data.Balance
        );
        const reserve = xrpl.dropsToXrp(
          accountInfo.result.account_data.OwnerCount * 2000000 + 10000000
        );

        currentAddress = address;
        document.getElementById("balance").textContent = `${balance} XRP`;
        document.getElementById("address").textContent = address;
        document.getElementById("reserve").textContent = `${reserve} XRP`;

        await loadTransactions(address);

        document.getElementById("connectCard").style.display = "none";
        document.getElementById("accountCard").style.display = "block";
        document.getElementById("transactionsCard").style.display = "block";
        // Don't show send card in lookup mode

        showMessage("Wallet lookup successful! (View-only mode)", "success");
      }

      // Load transactions for an address
      async function loadTransactions(address) {
        try {
          showMessage("Loading transactions...", "loading");

          const txResponse = await client.request({
            command: "account_tx",
            account: address,
            ledger_index_min: -1,
            ledger_index_max: -1,
            limit: 20,
            forward: false,
          });

          const transactions = txResponse.result.transactions;
          const listEl = document.getElementById("transactionsList");

          if (!transactions || transactions.length === 0) {
            listEl.innerHTML =
              '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">No transactions found</div>';
            showMessage("No transactions found", "success");
            return;
          }

          let html = "";
          transactions.forEach((txWrapper) => {
            const tx = txWrapper.tx;
            const meta = txWrapper.meta;

            const rippleEpochOffset = 946684800;
            const date = tx.date
              ? new Date((tx.date + rippleEpochOffset) * 1000)
              : new Date();

            let direction = "";
            let amount = "";
            let counterparty = "";
            let amountColor = "var(--text)";

            if (tx.TransactionType === "Payment") {
              if (tx.Account === address) {
                direction = "â†— Sent";
                counterparty = tx.Destination;
                amount = `-${xrpl.dropsToXrp(tx.Amount)} XRP`;
                amountColor = "var(--error)";
              } else if (tx.Destination === address) {
                direction = "â†™ Received";
                counterparty = tx.Account;
                amount = `+${xrpl.dropsToXrp(tx.Amount)} XRP`;
                amountColor = "var(--success)";
              }
            } else {
              direction = tx.TransactionType;
              amount = "N/A";
            }

            const status = meta.TransactionResult === "tesSUCCESS" ? "âœ“" : "âœ—";
            const statusColor =
              meta.TransactionResult === "tesSUCCESS"
                ? "var(--success)"
                : "var(--error)";

            const fee = tx.Fee ? xrpl.dropsToXrp(tx.Fee) : "0";
            const txHash = tx.hash || "Unknown";

            html += `
              <div class="clickable-tx" style="border-bottom: 1px solid var(--border); padding: 12px 0; border-radius: 8px;" onclick="viewTransactionDetails('${txHash}')">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span style="font-weight: 600; color: var(--text);">${direction}</span>
                  <span style="font-weight: 600; color: ${amountColor};">${amount}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary);">
                  <span>${date.toLocaleDateString()} ${date.toLocaleTimeString()}</span>
                  <span style="color: ${statusColor};">${status} ${meta.TransactionResult}</span>
                </div>
                ${
                  counterparty
                    ? `<div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">
                        <strong>Counterparty:</strong><br>
                        <span style="font-family: monospace; word-break: break-all;">${counterparty}</span>
                      </div>`
                    : ""
                }
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">
                  <strong>Hash:</strong> <span style="font-family: monospace;">${txHash.substring(0, 16)}...${txHash.substring(txHash.length - 8)}</span>
                </div>
                ${tx.DestinationTag !== undefined ? `
                  <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">
                    <strong>Destination Tag:</strong> ${tx.DestinationTag}
                  </div>
                ` : ''}
                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">
                  <strong>Fee:</strong> ${fee} XRP
                </div>
                <div style="font-size: 0.65rem; color: var(--primary); margin-top: 8px; text-align: center;">
                  Click for full details âžœ
                </div>
              </div>
            `;
          });

          listEl.innerHTML = html;
          showMessage(`Loaded ${transactions.length} transactions`, "success");
        } catch (error) {
          console.error("Error loading transactions:", error);
          showMessage("Failed to load transactions", "error");
        }
      }

      // Refresh balance display
      async function refreshBalance() {
        if (!currentWallet || !client) return;

        const accountInfo = await client.request({
          command: "account_info",
          account: currentWallet.address,
          ledger_index: "validated",
        });

        const balance = xrpl.dropsToXrp(
          accountInfo.result.account_data.Balance
        );
        const reserve = xrpl.dropsToXrp(
          accountInfo.result.account_data.OwnerCount * 2000000 + 10000000
        );

        currentAddress = currentWallet.address;
        document.getElementById("balance").textContent = `${balance} XRP`;
        document.getElementById("address").textContent = currentWallet.address;
        document.getElementById("reserve").textContent = `${reserve} XRP`;
      }

      // Disconnect wallet
      function disconnectWallet() {
        currentWallet = null;
        document.getElementById("secretKey").value = "";
        document.getElementById("connectCard").style.display = "block";
        document.getElementById("accountCard").style.display = "none";
        document.getElementById("transactionsCard").style.display = "none";
        document.getElementById("sendCard").style.display = "none";
        showMessage("Wallet disconnected", "success");
      }

      // Send payment
      async function sendPayment() {
        if (!currentWallet) {
          showMessage("Please connect your wallet first", "error");
          return;
        }

        const destinationAddress = document
          .getElementById("destinationAddress")
          .value.trim();
        const amount = document.getElementById("amount").value.trim();
        const destinationTag = document
          .getElementById("destinationTag")
          .value.trim();

        if (!destinationAddress) {
          showMessage("Please enter a destination address", "error");
          return;
        }

        if (!amount || parseFloat(amount) <= 0) {
          showMessage("Please enter a valid amount", "error");
          return;
        }

        // Disable button to prevent double-submission
        const sendButton = event.target;
        sendButton.disabled = true;

        try {
          showMessage("Preparing transaction...", "loading");

          const payment = {
            TransactionType: "Payment",
            Account: currentWallet.address,
            Amount: xrpl.xrpToDrops(amount),
            Destination: destinationAddress,
          };

          if (destinationTag && parseInt(destinationTag) >= 0) {
            payment.DestinationTag = parseInt(destinationTag);
          }

          console.log("Preparing payment:", payment);
          const prepared = await client.autofill(payment);
          console.log("Prepared payment:", prepared);

          showMessage("Signing transaction...", "loading");
          const signed = currentWallet.sign(prepared);
          console.log("Signed transaction:", signed.hash);

          showMessage("Submitting to network...", "loading");
          const submitResult = await client.submit(signed.tx_blob);
          console.log("Submit result:", submitResult);

          // Handle various submission results
          const engineResult = submitResult.result.engine_result;

          // Handle redundant transaction - it's already in the queue
          if (engineResult === "temREDUNDANT") {
            showMessage(
              "Transaction already submitted, checking status...",
              "loading"
            );
            // Use the hash from the previous submission
            const txHash = submitResult.result.tx_json?.hash || signed.hash;
            console.log("Checking redundant transaction:", txHash);
            signed.hash = txHash; // Update hash to check
          }

          if (
            engineResult === "tesSUCCESS" ||
            engineResult === "terQUEUED" ||
            engineResult === "temREDUNDANT"
          ) {
            showMessage(
              "Transaction submitted! Waiting for validation...",
              "loading"
            );

            // Wait for validation (up to 20 seconds)
            let validated = false;
            for (let i = 0; i < 40; i++) {
              await new Promise((resolve) => setTimeout(resolve, 500));
              try {
                const txResult = await client.request({
                  command: "tx",
                  transaction: signed.hash,
                });

                if (txResult.result.validated) {
                  validated = true;
                  if (txResult.result.meta.TransactionResult === "tesSUCCESS") {
                    showMessage("Payment sent successfully!", "success");

                    // Save address to history
                    saveAddressToHistory(destinationAddress);

                    // Clear form
                    document.getElementById("destinationAddress").value = "";
                    document.getElementById("amount").value = "";
                    document.getElementById("destinationTag").value = "";

                    // Refresh balance and transactions
                    await refreshBalance();
                    await loadTransactions(currentWallet.address);
                  } else {
                    showMessage(
                      `Payment failed: ${txResult.result.meta.TransactionResult}`,
                      "error"
                    );
                  }
                  break;
                }
              } catch (e) {
                // Transaction not found yet, keep waiting
              }
            }

            if (!validated) {
              showMessage(
                "Transaction submitted but validation timeout. Check your account history.",
                "error"
              );
            }
          } else {
            showMessage(
              `Transaction rejected: ${
                submitResult.result.engine_result_message || engineResult
              }`,
              "error"
            );
          }
        } catch (error) {
          console.error("Payment error:", error);

          // Handle specific error cases
          if (error.data?.error === "txnNotFound") {
            showMessage(
              "Transaction submitted but not found yet. Please wait...",
              "loading"
            );
          } else if (error.data?.error_message?.includes("redundant")) {
            showMessage(
              "Transaction already submitted. Please wait for validation.",
              "error"
            );
          } else {
            showMessage(
              "Payment failed: " + (error.data?.error_message || error.message),
              "error"
            );
          }
        } finally {
          // Re-enable button
          sendButton.disabled = false;
        }
      }

      // Update network status
      function updateNetworkStatus(text, connected) {
        document.getElementById("networkText").textContent = text;
        const dot = document.getElementById("networkDot");
        if (connected) {
          dot.classList.add("connected");
        } else {
          dot.classList.remove("connected");
        }
      }

      // Show message
      function showMessage(message, type) {
        const existing = document.querySelector(".message");
        if (existing) existing.remove();

        const div = document.createElement("div");
        div.className = `message ${type}`;
        div.textContent = message;

        document.getElementById("messageContainer").appendChild(div);

        if (type !== "loading") {
          setTimeout(() => div.remove(), 5000);
        }
      }

      // Auto-connect on load
      window.addEventListener("load", () => {
        connectToNetwork();
        updateAddressDatalist();
      });
    </script>
  </body>
</html>
